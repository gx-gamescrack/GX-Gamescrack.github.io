<!DOCTYPE html>
<html lang="en-us">
  <head>
    <base href="https://cdn.jsdelivr.net/gh/web-ports/cuphead@0a443a6e79ff762010b31d771086d17280f9db42/">
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Cuphead</title>
    <style>
      html,
      body {
          margin: 0;
          padding: 0;
          height: 100%;
          overflow: hidden;
          background: #231F20;
      }

      #unity-canvas {
          position: fixed;
          inset: 0;
          width: 100%;
          height: 100%;
          display: none;
          background: #231F20;
      }
  </style>
  <script src="TemplateData/UnityProgress.js"></script>
    <script src="Build/UnityLoader.js"></script>
  </head>
  <body>
    <div id="loading-text" style="color: white; font-size: 48px; font-family: cursive; text-align: center; margin-top: 20px;"> LOADING... </div>
    <div id="unityContainer"></div>
    <script>
      var loadingText = document.querySelector("#loading-text");
      let loadedBytes = 0;

      // Open IndexedDB
      function openDB() {
          return new Promise((resolve, reject) => {
              const request = indexedDB.open('CupheadCache', 1);
              request.onerror = () => reject(request.error);
              request.onsuccess = () => resolve(request.result);
              request.onupgradeneeded = (event) => {
                  const db = event.target.result;
                  if (!db.objectStoreNames.contains('files')) {
                      db.createObjectStore('files');
                  }
              };
          });
      }

      // Get file from IndexedDB
      async function getFromDB(db, key) {
          return new Promise((resolve, reject) => {
              const transaction = db.transaction(['files'], 'readonly');
              const store = transaction.objectStore('files');
              const request = store.get(key);
              request.onsuccess = () => resolve(request.result);
              request.onerror = () => reject(request.error);
          });
      }

      // Save file to IndexedDB
      async function saveToDB(db, key, data) {
          return new Promise((resolve, reject) => {
              const transaction = db.transaction(['files'], 'readwrite');
              const store = transaction.objectStore('files');
              const request = store.put(data, key);
              request.onsuccess = () => resolve();
              request.onerror = () => reject(request.error);
          });
      }

      // Fetch with progress and caching
      async function fetchWithProgress(url, useCache = true) {
          const db = await openDB();
          const cacheKey = url;

          // Try to get from cache first
          if (useCache) {
              const cached = await getFromDB(db, cacheKey);
              if (cached) {
                  console.log('Loading from cache:', url);
                  loadedBytes += cached.byteLength;
                  let mbDone = (loadedBytes / (1024 * 1024)).toFixed(2);
                  let mbTotal = '2127.34';
                  loadingText.innerHTML = `LOADING... ${mbDone} MB / ${mbTotal} MB<br><span style="color: #66ff66; font-size: 24px;">Loader Optimized By Jon Stearns</span>`;
                  return cached;
              }
          }

          // Fetch from network
          const response = await fetch(url);
          const reader = response.body.getReader();
          let chunks = [];
          let received = 0;

          while (true) {
              const { done, value } = await reader.read();
              if (done) break;
              received += value.length;
              loadedBytes += value.length;
              chunks.push(value);

              let mbDone = (loadedBytes / (1024 * 1024)).toFixed(2);
              let mbTotal = '2127.34';
              loadingText.innerHTML = `LOADING... ${mbDone} MB / ${mbTotal} MB<br><span style="color: red;">First time playing always takes forever</span>`;
          }

          let fullBuffer = new Uint8Array(received);
          let offset = 0;
          for (let chunk of chunks) {
              fullBuffer.set(chunk, offset);
              offset += chunk.length;
          }

          // Save to cache
          try {
              await saveToDB(db, cacheKey, fullBuffer.buffer);
              console.log('Saved to cache:', url);
          } catch (e) {
              console.warn('Failed to cache:', url, e);
          }

          // Clear chunks to help GC
          chunks = null;

          return fullBuffer.buffer;
      }

      // Merge files sequentially to reduce memory pressure
      async function mergeFiles(fileParts) {
          const blobs = [];
          
          for (const part of fileParts) {
              const buffer = await fetchWithProgress(part);
              blobs.push(new Blob([buffer]));
          }
          
          const mergedBlob = new Blob(blobs);
          const url = URL.createObjectURL(mergedBlob);
          
          // Clear blobs array to help GC
          blobs.length = 0;
          
          return url;
      }

      function getParts(file, start, end) {
          let parts = [];
          for (let i = start; i <= end; i++) {
              parts.push(file + ".part" + i);
          }
          return parts;
      }

      function resizeUnityContainer() {
          var container = document.getElementById("unityContainer");
          var canvas = container.querySelector("canvas");

          container.style.width = window.innerWidth + "px";
          container.style.height = window.innerHeight + "px";

          if (canvas) {
              canvas.style.width = window.innerWidth + "px";
              canvas.style.height = window.innerHeight + "px";
          }
      }

      (async () => {
          try {
              // Load files sequentially to reduce peak memory usage
              loadingText.innerHTML = 'LOADING ASM CODE...<br><span style="font-size: 20px; color: #ffff66;">Close other tabs for best performance</span>';
              const asmurl = await mergeFiles(getParts("Build/Build.asm.code.unityweb", 1, 3));
              
              loadingText.innerHTML = 'LOADING GAME DATA...<br><span style="font-size: 20px; color: #ffff66;">This is the largest file (1.9GB)</span>';
              const dataUrl = await mergeFiles(getParts("Build/Build.data.unityweb", 1, 103));
              
              loadingText.innerHTML = 'LOADING WASM CODE...<br><span style="font-size: 20px; color: #ffff66;">Almost done!</span>';
              const wasmurl = await mergeFiles(getParts("Build/Build.wasm.code.unityweb", 1, 2));

              const json = {
                  "companyName": "SpanishFreddy",
                  "productName": "Cuphead",
                  "dataUrl": dataUrl,
                  "wasmCodeUrl": wasmurl,
                  "wasmFrameworkUrl": "Build.wasm.framework.unityweb",
                  "asmCodeUrl": asmurl,
                  "asmMemoryUrl": "Build.asm.memory.unityweb",
                  "asmFrameworkUrl": "Build.asm.framework.unityweb",
                  "TOTAL_MEMORY": 2130706432,
                  "graphicsAPI": ["WebGL 2.0", "WebGL 1.0"],
                  "webglContextAttributes": {"preserveDrawingBuffer": false},
                  "splashScreenStyle": "Dark",
                  "backgroundColor": "#231F20"
              };

              let blob = new Blob([JSON.stringify(json)], { type: "application/json" });
              let blobUrl = URL.createObjectURL(blob);
              window.addEventListener("resize", resizeUnityContainer);

              loadingText.innerHTML = 'INITIALIZING GAME...<br><span style="font-size: 20px; color: #66ff66;">Starting Unity Engine</span>';

              UnityLoader.instantiate("unityContainer", json, {
                  url: blobUrl,
                  Module: {
                      onRuntimeInitialized: function () {
                          resizeUnityContainer();
                          document.querySelector("#loading-text").remove();
                      },
                  },
              });
          } catch (e) {
              loadingText.innerHTML = '<span style="color: red; font-size: 32px;">ERROR LOADING GAME<br><br></span>' +
                  '<span style="font-size: 20px;">' + e.message + '<br><br>Try refreshing or clearing browser data</span>';
              console.error('Loading error:', e);
          }
      })();
    </script>
  </body>
</html>