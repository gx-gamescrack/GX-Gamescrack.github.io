// all.js â€” universal login handler
(async () => {
    const loginPage = '/login.html';
    const homePage = '/index.html';
    const googleForm = 'https://forms.gle/xoYAygpNXhdkPsGm8'; // Replace with your Google Form
    let allowedUsers = [];

    // Load allowed users from /user.json
    try {
        const res = await fetch('/user.json', { cache: 'no-store' });
        if (!res.ok) throw new Error('Cannot fetch user.json');
        const data = await res.json();
        allowedUsers = data.allowedUsers || [];
    } catch (err) {
        console.error('Error loading allowed users:', err);
        if (!location.pathname.endsWith('login.html')) {
            window.location.href = loginPage;
        }
        return;
    }

    const username = localStorage.getItem('username');

    // LOGIN PAGE LOGIC
    if (location.pathname.endsWith('login.html')) {
        const loginBtn = document.getElementById('loginBtn');
        const usernameInput = document.getElementById('username');

        // Auto-redirect if already logged in
        if (username && allowedUsers.includes(username)) {
            window.location.href = homePage;
            return;
        }

        const showMessage = (text, type) => {
            const el = document.getElementById('message');
            el.textContent = text;
            el.className = 'message ' + type;
            el.style.display = 'block';
        };

        const login = () => {
            const userVal = usernameInput.value.trim();
            if (!userVal) return showMessage('Please enter a username', 'error');

            const isEightDigits = /^\d{8}$/.test(userVal);

            if (isEightDigits) {
                if (allowedUsers.includes(userVal)) {
                    localStorage.setItem('username', userVal);
                    window.location.href = homePage;
                } else {
                    window.location.href = googleForm;
                }
                return;
            }

            showMessage('School administrators are not authorized', 'error');
        };

        loginBtn.addEventListener('click', login);
        usernameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') login();
        });

        return;
    }

    // PROTECT ALL OTHER PAGES
    if (!username || !allowedUsers.includes(username)) {
        window.location.href = loginPage;
    }

})();
